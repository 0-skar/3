<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <!-- ZMIANA: Usuniƒôto 'width=device-width' aby strona nie skalowa≈Ça siƒô na mobile -->
    <meta name="viewport" content="user-scalable=yes">
    <title>Forum</title>
    <style>
        :root {
            --background-color: #2c2f33; --secondary-bg-color: #23272a; --text-color: #ffffff; 
            --text-muted-color: #99aab5; --accent-color: #7289da; --private-msg-color: #f0b90c; 
            --border-color: #444; --hover-color: #3a3e42; --danger-color: #dc3545;
            --sidebar-width: 240px; --header-height: 52px;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background-color: var(--secondary-bg-color); }
        
        /* ZMIANA: Solidna struktura flexbox dla ca≈Çego layoutu */
        .app-layout { display: flex; flex-direction: column; height: 100vh; }
        .main-content { display: flex; flex-direction: row; flex-grow: 1; min-height: 0; }
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; background-color: var(--background-color); }
        .sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: var(--secondary-bg-color); display: flex; flex-direction: column; border-left: 1px solid var(--border-color); transition: width 0.3s; }
        
        .chat-header { height: var(--header-height); box-sizing: border-box; padding: 0 15px; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; background-color: var(--secondary-bg-color); border-bottom: 1px solid var(--border-color); }
        #header-title { color: var(--private-msg-color); font-weight: bold; font-size: 1.25rem; }
        
        .sidebar.collapsed { width: 0; min-width: 0; border-left: none; overflow: hidden; }
        .chat-tabs { height: var(--header-height); box-sizing: border-box; border-bottom: 1px solid var(--border-color); padding: 0 5px; flex-shrink: 0; display: flex; align-items: center; }
        .user-slots-area { padding: 10px; flex-grow: 1; overflow-y: auto; min-height: 0; }
        .user-slots-area h3 { margin: 5px 0 15px; font-size: 0.9rem; text-transform: uppercase; color: var(--text-muted-color); }
        
        .chat-windows { position: relative; flex-grow: 1; min-height: 0; }
        .messages { list-style-type: none; margin: 0; padding: 15px; position: absolute; inset: 0; overflow-y: auto; }
        .system-message, .user-message { padding-bottom: 8px; word-wrap: break-word; }
        .system-message { color: var(--text-muted-color); font-style: italic; text-align: center; }
        .private-message { color: var(--private-msg-color); font-style: italic; }
        .user-message .username-color { color: var(--accent-color); font-weight: bold; }
        
        #form { flex-shrink: 0; display: flex; padding: 10px; background-color: var(--secondary-bg-color); border-top: 1px solid var(--border-color); }
        #input { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); background-color: #40444b; color: var(--text-color); border-radius: 8px; font-size: 1rem; }
        #form button { padding: 12px 18px; margin-left: 10px; border: none; background-color: var(--accent-color); color: var(--text-color); border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .user-slot { display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background-color: var(--background-color); border-radius: 5px; border: 1px solid var(--border-color); }
        .user-slot .user-name { font-weight: bold; flex-grow: 1; font-size: 1rem; cursor: pointer; white-space: nowrap; }
        .user-slot.inactive .user-name { color: var(--text-muted-color); font-style: italic; }
        
        .join-form-inline { width: 100%; display: flex; flex-direction: column; gap: 5px; }
        .join-form-inline input { padding: 8px; background: var(--secondary-bg-color); border: 1px solid var(--border-color); color: white; border-radius: 3px; }
        .join-form-inline button { padding: 8px; background: var(--accent-color); border: none; color: white; border-radius: 3px; cursor: pointer; }
        
        .self-management-panel { padding: 15px; color: var(--text-color); }
    </style>
</head>
<body>
    <div class="app-layout">
        <div class="main-content">
            <div class="chat-area">
                <div class="chat-header" id="chat-header"><span id="header-title">Forum</span><button id="sidebar-toggle" style="margin-left:auto;"><</button></div>
                <div class="chat-windows" id="chat-windows"></div>
            </div>
            <div class="sidebar" id="sidebar">
                <div class="chat-tabs" id="chat-tabs"></div>
                <div class="user-slots-area"><h3>U≈ºytkownicy</h3><div id="user-slots-container"></div></div>
            </div>
        </div>
        <form id="form" action=""><input id="input" autocomplete="off" placeholder="Do≈ÇƒÖcz, aby rozmawiaƒá..." disabled /><button type="submit" disabled>Wy≈õlij</button></form>
    </div>
    
    <script>
        const ui = { form: document.getElementById('form'), input: document.getElementById('input'), sendButton: document.getElementById('form').querySelector('button'), chatWindows: document.getElementById('chat-windows'), chatTabs: document.getElementById('chat-tabs'), userSlotsContainer: document.getElementById('user-slots-container'), sidebar: document.getElementById('sidebar'), sidebarToggle: document.getElementById('sidebar-toggle') };
        let socket, username = null, userRole = null;

        function createChatWindow(id, name, isPrivate = false) {
            if (document.getElementById(`content-${id}`)) return;
            const contentDiv = document.createElement('div');
            contentDiv.style.display = 'none';
            contentDiv.className = 'messages';
            contentDiv.id = `content-${id}`;
            if (isPrivate) {
                const messagesUl = document.createElement('ul');
                messagesUl.id = `messages-${id}`;
                contentDiv.appendChild(messagesUl);
            } else {
                contentDiv.innerHTML = `<div class="self-management-panel"><h4>Moje Konto</h4><p>Ustaw has≈Ço, aby Twoje konto sta≈Ço siƒô sta≈Çe.</p><input type="password" id="new-password-input" placeholder="Wpisz nowe has≈Ço..."><button id="save-password-btn">Zapisz i zarejestruj konto</button></div>`;
            }
            ui.chatWindows.appendChild(contentDiv);
            
            const tabButton = document.createElement('button');
            tabButton.className = 'tab-button';
            tabButton.textContent = name;
            tabButton.id = `tab-${id}`;
            tabButton.onclick = () => switchChat(id);
            ui.chatTabs.appendChild(tabButton);

            if (!isPrivate) {
                document.getElementById('save-password-btn').onclick = () => {
                    const pass = document.getElementById('new-password-input').value;
                    if (pass) socket.send(JSON.stringify({ type: 'register_account', payload: { password: pass } }));
                };
            }
        }
        
        function switchChat(id) {
            document.querySelectorAll('.chat-windows > div').forEach(el => el.style.display = 'none');
            document.getElementById(`content-${id}`).style.display = 'block';
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
        }
        
        function addMessage(data, targetChatId) {
            const containerId = targetChatId === 'public' ? 'content-public' : `messages-${targetChatId}`;
            const messagesContainer = document.getElementById(containerId);
            if (!messagesContainer) return;
            const item = document.createElement('li');
            item.className = data.username === "System" ? 'system-message' : 'user-message';
            if (data.isPrivate) item.classList.add('private-message');
            item.innerHTML = data.username === "System" ? data.message : `<span class="username-color">${data.username}</span>: ${data.message}`;
            const targetUl = messagesContainer.tagName === 'UL' ? messagesContainer : messagesContainer.querySelector('ul');
            targetUl.appendChild(item);
            targetUl.scrollTop = targetUl.scrollHeight;
        }

        function updateUsers(users) {
            users.sort((a, b) => a.username.localeCompare(b.username));
            ui.userSlotsContainer.innerHTML = '';
            users.forEach(user => {
                const slot = document.createElement('div');
                slot.className = 'user-slot';
                if (user.status === 'inactive') slot.classList.add('inactive');
                
                let icon = '';
                if (user.role === 'moderator') icon = 'üëë ';
                else if (user.type === 'registered') icon = '‚≠ê ';

                const nameEl = document.createElement('span');
                nameEl.className = 'user-name';
                nameEl.innerHTML = `${icon}${user.username}${user.username === username ? ' (Ty)' : ''}`;
                nameEl.onclick = () => {
                    const targetId = user.username === username ? 'self-management' : user.username;
                    createChatWindow(targetId, user.username === username ? 'Moje Konto' : user.username, user.username !== username);
                    switchChat(targetId);
                    if (user.username !== username) socket.send(JSON.stringify({ type: "get_private_history", payload: { partner: user.username } }));
                };
                slot.appendChild(nameEl);

                if (username && user.username !== username && userRole === 'moderator') {
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = '√ó';
                    removeBtn.style.cssText = 'margin-left: auto; background: none; border: none; color: var(--text-muted-color); cursor: pointer; font-size: 1.2rem;';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`UsunƒÖƒá u≈ºytkownika ${user.username}? Spowoduje to usuniƒôcie konta na sta≈Çe.`)) {
                            socket.send(JSON.stringify({ type: 'remove_user', payload: { username: user.username }}));
                        }
                    };
                    slot.appendChild(removeBtn);
                }
                ui.userSlotsContainer.appendChild(slot);
            });
            if (!username) createRegistrationSlot();
        }
        
        function createRegistrationSlot() {
            if (document.getElementById('join-slot')) return;
            const slot = document.createElement('div');
            slot.id = 'join-slot';
            slot.className = 'user-slot';
            
            const form = document.createElement('form');
            form.className = 'join-form-inline';
            form.innerHTML = `<input type="text" id="join-username" placeholder="Twoja nazwa" required><input type="password" id="join-password" placeholder="Has≈Ço (opcjonalne)"><button type="submit">Do≈ÇƒÖcz</button>`;
            form.onsubmit = (e) => {
                e.preventDefault();
                const joinUsername = form.querySelector('#join-username').value.trim();
                const joinPassword = form.querySelector('#join-password').value;
                if (joinUsername) {
                    socket.send(JSON.stringify({ type: 'join', payload: { username: joinUsername, password: joinPassword } }));
                }
            };
            slot.appendChild(form);
            ui.userSlotsContainer.appendChild(slot);
        }

        function connectWebSocket() {
            socket = new WebSocket("wss://eosforus-chat.hf.space/ws/");
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch(data.type) {
                    case 'welcome':
                        username = data.payload.username; userRole = data.payload.role;
                        ui.input.disabled = false; ui.sendButton.disabled = false;
                        ui.input.placeholder = "Wpisz wiadomo≈õƒá...";
                        document.getElementById('join-slot')?.remove();
                        break;
                    case 'user_update': updateUsers(data.payload.users); break;
                    case 'chat_message': addMessage(data.payload, 'public'); break;
                    case 'private_message':
                        const partner = data.payload.sender === username ? data.payload.recipient : data.payload.sender;
                        addMessage(data.payload, partner);
                        break;
                    case 'private_history_data':
                        const partnerId = data.payload.partner;
                        if (!document.getElementById(`content-${partnerId}`)) createChatWindow(partnerId, partnerId, true);
                        data.payload.history.forEach(msg => addMessage({...msg, isPrivate: true}, partnerId));
                        break;
                    case 'account_updated': alert(data.payload.message); break;
                    case 'error': alert(`B≈ÇƒÖd: ${data.payload.message}`); break;
                }
            };
            socket.onclose = () => { setTimeout(connectWebSocket, 3000); };
        }

        ui.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = ui.input.value.trim();
            if (!message) return;
            const activeTabId = document.querySelector('.tab-button.active')?.id;
            if (!activeTabId) return;

            const targetId = activeTabId.replace('tab-', '');
            if (targetId === 'self-management') return; // Nie wysy≈Çaj wiadomo≈õci do siebie
            
            const type = targetId === 'public' ? 'chat_message' : 'private_message';
            const payload = targetId === 'public' ? { message } : { recipient: targetId, message };
            socket.send(JSON.stringify({ type, payload }));
            ui.input.value = '';
        });
        
        ui.sidebarToggle.addEventListener('click', () => ui.sidebar.classList.toggle('collapsed'));

        createChatWindow('public', 'Czat Publiczny', true);
        switchChat('public');
        connectWebSocket();
    </script>
</body>
</html>
