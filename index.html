<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Forum</title>
    <style>
        /* ... wszystkie style CSS pozostają takie same jak w poprzednim kroku ... */
        /* === DODATKOWE STYLE DLA PANELU PROFILU === */
        .profile-actions { padding: 20px; text-align: center; }
        .profile-actions button {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        #logout-btn { background-color: var(--accent-color); }
        #delete-account-btn { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <!-- ... cała struktura HTML pozostaje taka sama jak w poprzednim kroku ... -->
    <script>
        // ... większość kodu JavaScript pozostaje bez zmian ...

        // === ZMODYFIKOWANA FUNKCJA UPDATEUSERS ===
        function updateUsers(users) {
            // ... (sortowanie i sprawdzanie moderatora bez zmian) ...
            
            users.forEach(user => {
                // ... (tworzenie slotu i nagłówka bez zmian) ...
                
                // === ZMIANA W LOGICE KLIKNIĘCIA ===
                if (user.username === username) {
                    // Kliknięcie na własny profil otwiera panel zarządzania
                    header.querySelector('.user-name').onclick = () => openSelfProfile();
                    
                    nameHTML += ' (Ty)';
                    if (user.role !== 'moderator' && !user.username.includes('(Gość)')) {
                        actionsHTML += `<button class="action-button promote-button" title="Zostań moderatorem">🔑</button>`;
                    }
                    // Przycisk wylogowania zostaje usunięty stąd, bo będzie w panelu
                } else {
                     header.querySelector('.user-name').onclick = () => { if(user.online) openPrivateChat(user.username); else alert('Użytkownik jest offline.'); };
                }

                if (isModerator && user.username !== username && user.online) {
                     actionsHTML += `<button class="action-button remove-user-button" data-user="${user.username}" title="Usuń użytkownika">×</button>`;
                }
                
                header.innerHTML = `<span class="user-name ${user.role}">${nameHTML}</span> ${actionsHTML}`;
                // ... (reszta logiki przycisków bez zmian) ...
            });
            // ... (logika przycisku dołączania bez zmian) ...
        }

        // === NOWA FUNKCJA DO OTWIERANIA PANELU PROFILU ===
        function openSelfProfile() {
            const profileId = 'self-profile';
            const profileName = 'Mój Profil';
            if (!document.getElementById(`tab-${profileId}`)) {
                // Stwórz zakładkę i okno, tak jak dla czatu
                createChatWindow(profileId, profileName);
                
                // Wypełnij okno przyciskami zamiast wiadomościami
                const profileWindow = document.getElementById(`messages-${profileId}`);
                profileWindow.innerHTML = `
                    <div class="profile-actions">
                        <p>Zarządzaj swoim kontem</p>
                        <button id="logout-btn">Wyloguj</button>
                        <button id="delete-account-btn">Usuń Konto</button>
                    </div>
                `;

                // Dodaj logikę do przycisków
                document.getElementById('logout-btn').onclick = () => {
                    socket.close();
                    localStorage.removeItem('forumCredentials');
                    resetUI();
                };

                document.getElementById('delete-account-btn').onclick = () => {
                    const confirmation = prompt("Czy na pewno chcesz trwale usunąć swoje konto i całą historię rozmów? Tej akcji nie można cofnąć. Wpisz swoją nazwę użytkownika, aby potwierdzić:");
                    if (confirmation === username) {
                        socket.send(JSON.stringify({ type: 'delete_account' }));
                    } else if (confirmation !== null) {
                        alert("Nazwa użytkownika się nie zgadza. Anulowano usuwanie konta.");
                    }
                };
            }
            switchChat(profileId);
        }
        
        // === ZMODYFIKOWANA FUNKCJA OTWIERANIA PRYWATNEGO CZATU ===
        async function openPrivateChat(targetUser) {
            const chatId = targetUser;
            if (!document.getElementById(`messages-${chatId}`)) {
                createChatWindow(chatId, `Czat z ${targetUser}`);
                // Pobierz historię prywatnej rozmowy
                try {
                    const response = await fetch(`${historyUrl.replace('/history', '')}/private_history/${targetUser}?current_user=${username}`);
                    if (response.ok) {
                        const privateHistory = await response.json();
                        privateHistory.forEach(msg => addMessage(msg, chatId));
                    }
                } catch (e) { console.error("Błąd ładowania prywatnej historii:", e); }
            }
            switchChat(chatId);
        }

        // ... (reszta kodu JavaScript bez większych zmian) ...

        // W onmessage dodajemy nową obsługę
        socket.onmessage = (event) => {
            // ...
            case 'force_logout':
                alert(data.payload.message);
                socket.onclose = null; // Zapobiegaj próbie ponownego połączenia
                socket.close();
                localStorage.removeItem('forumCredentials');
                resetUI();
                break;
            // ...
        }
    </script>
</body>
</html>
