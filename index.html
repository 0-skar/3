<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Forum</title>
    <style>
        :root {
            --background-color: #2c2f33;
            --secondary-bg-color: #23272a;
            --header-bg-color: #1e2124;
            --text-color: #ffffff;
            --text-muted-color: #99aab5;
            --accent-color: #7289da;
            --private-msg-color: #f0b90c;
            --border-color: #444;
            --hover-color: #3a3e42;
        }
        body { font-family: 'Helvetica Neue', sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--header-bg-color); color: var(--text-color); }
        .main-container { display: flex; flex-grow: 1; }
        .chat-area { display: flex; flex-direction: column; flex-grow: 1; height: 100%; }
        .chat-header { padding: 15px 20px; font-size: 20px; font-weight: bold; background-color: var(--secondary-bg-color); border-bottom: 1px solid var(--border-color); }
        .chat-windows { position: relative; flex-grow: 1; background-color: var(--background-color); }
        .messages { list-style-type: none; margin: 0; padding: 20px; position: absolute; top: 0; bottom: 0; left: 0; right: 0; overflow-y: scroll; opacity: 0; visibility: hidden; transition: opacity 0.2s; }
        .messages.active { opacity: 1; visibility: visible; }
        .system-message { color: var(--text-muted-color); font-style: italic; text-align: center; padding: 5px 0; }
        .user-message b { color: var(--accent-color); }
        .private-message { color: var(--private-msg-color); font-style: italic; }
        #form { display: flex; padding: 10px; background-color: var(--secondary-bg-color); border-top: 1px solid var(--border-color); }
        #input { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); background-color: #40444b; color: var(--text-color); border-radius: 5px; }
        #form button { padding: 10px 15px; margin-left: 10px; border: none; background-color: var(--accent-color); color: var(--text-color); border-radius: 5px; cursor: pointer; }

        .sidebar { width: 240px; flex-shrink: 0; background-color: var(--secondary-bg-color); display: flex; flex-direction: column; }
        .chat-tabs { border-bottom: 1px solid var(--border-color); padding: 5px; }
        .tab-button { width: 100%; background: none; border: none; color: var(--text-muted-color); padding: 10px; text-align: left; cursor: pointer; border-radius: 5px; margin-bottom: 2px; }
        .tab-button:hover { background-color: var(--hover-color); }
        .tab-button.active { color: var(--text-color); background-color: var(--accent-color); }
        .user-slots-area { padding: 10px; flex-grow: 1; overflow-y: auto; }
        .user-slots-area h3 { margin: 5px 0 15px; font-size: 14px; text-transform: uppercase; color: var(--text-muted-color); }
        .user-slot { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background-color: var(--background-color); border-radius: 5px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .user-slot:hover { background-color: var(--hover-color); }
        .user-slot .plus-icon { font-size: 24px; font-weight: bold; color: var(--text-muted-color); margin: auto; }
        .user-slot .user-name { font-weight: bold; }
        
        #join-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        #join-modal { background-color: var(--background-color); padding: 30px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #join-modal h2 { margin-top: 0; }
        #username-input { width: 100%; padding: 12px; margin: 15px 0; background: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: white; }
        #join-modal button { width: 100%; padding: 12px; background: var(--accent-color); border: none; border-radius: 5px; color: white; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <div class="chat-tabs" id="chat-tabs"></div>
            <div class="user-slots-area">
                <h3>Użytkownicy</h3>
                <div id="user-slots-container"></div>
            </div>
        </div>
        <div class="chat-area">
            <div class="chat-header" id="chat-header">Forum</div>
            <div class="chat-windows" id="chat-windows"></div>
            <form id="form" action="">
                <input id="input" autocomplete="off" placeholder="Dołącz, aby rozmawiać..." disabled />
                <button disabled>Wyślij</button>
            </form>
        </div>
    </div>

    <div id="join-overlay">
        <div id="join-modal">
            <h2>Dołącz do Forum</h2>
            <form id="join-form">
                <input id="username-input" autocomplete="off" placeholder="Twoja nazwa..." required>
                <button type="submit">Dołącz</button>
            </form>
        </div>
    </div>

    <script>
        const ui = { form: document.getElementById('form'), input: document.getElementById('input'), sendButton: document.querySelector('#form button'), chatWindows: document.getElementById('chat-windows'), chatTabs: document.getElementById('chat-tabs'), userSlotsContainer: document.getElementById('user-slots-container'), chatHeader: document.getElementById('chat-header'), joinOverlay: document.getElementById('join-overlay'), joinForm: document.getElementById('join-form'), usernameInput: document.getElementById('username-input') };
        let socket, username = null, activeChat = 'public';
        const hfSpaceUrl = "eosforus-chat.hf.space";
        const wsUrl = `wss://${hfSpaceUrl}/ws/`;
        const historyUrl = `https://${hfSpaceUrl}/history`;

        function createChatWindow(id, name) {
            if (document.getElementById(`messages-${id}`)) return;
            const messagesDiv = document.createElement('ul');
            messagesDiv.className = 'messages';
            messagesDiv.id = `messages-${id}`;
            ui.chatWindows.appendChild(messagesDiv);
            const tabButton = document.createElement('button');
            tabButton.className = 'tab-button';
            tabButton.id = `tab-${id}`;
            tabButton.textContent = name;
            tabButton.onclick = () => switchChat(id);
            ui.chatTabs.appendChild(tabButton);
        }

        function switchChat(id) {
            activeChat = id;
            document.querySelectorAll('.messages').forEach(el => el.classList.remove('active'));
            document.getElementById(`messages-${id}`).classList.add('active');
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
        }

        function addMessage(data, targetChat) {
            const messagesDiv = document.getElementById(`messages-${targetChat}`);
            if (!messagesDiv) return;
            const item = document.createElement('li');
            if (data.username === "System") { item.className = 'system-message'; item.textContent = data.message; } 
            else {
                item.className = 'user-message';
                item.innerHTML = `<b>${data.username}:</b> ${data.message}`;
                if (data.isPrivate) item.classList.add('private-message');
            }
            messagesDiv.appendChild(item);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateUsers(users) {
            ui.userSlotsContainer.innerHTML = '';
            users.forEach(user => {
                const slot = document.createElement('div');
                slot.className = 'user-slot';
                if (user === username) {
                    slot.innerHTML = `<span class="user-name">${user} (Ty)</span>`;
                } else {
                    slot.innerHTML = `<span class="user-name">${user}</span>`;
                    slot.onclick = () => openPrivateChat(user);
                }
                ui.userSlotsContainer.appendChild(slot);
            });
            const newSlot = document.createElement('div');
            newSlot.className = 'user-slot';
            newSlot.innerHTML = `<span class="plus-icon">+</span>`;
            newSlot.onclick = () => { if (!username) ui.joinOverlay.style.display = 'flex'; };
            if (username) newSlot.style.cursor = 'not-allowed'; // Zablokuj dołączanie po raz drugi
            ui.userSlotsContainer.appendChild(newSlot);
        }

        function openPrivateChat(targetUser) {
            createChatWindow(targetUser, `Czat z ${targetUser}`);
            switchChat(targetUser);
        }
        
        async function loadHistory() { try { const r = await fetch(historyUrl); const h = await r.json(); h.forEach(m => addMessage(m, 'public')); } catch (e) { console.error(e); } }
        
        function connectWebSocket() {
            socket = new WebSocket(wsUrl);
            socket.onopen = () => { loadHistory(); };
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'chat_message') { addMessage(data.payload, 'public'); }
                else if (data.type === 'user_update') { updateUsers(data.payload.users); }
                else if (data.type === 'private_message') {
                    const sender = data.payload.sender;
                    const chatPartner = sender === username ? data.payload.recipient : sender;
                    createChatWindow(chatPartner, `Czat z ${chatPartner}`);
                    addMessage({ ...data.payload, isPrivate: true }, chatPartner);
                }
            };
        }

        ui.joinForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const chosenUsername = ui.usernameInput.value.trim();
            if (chosenUsername) {
                username = chosenUsername;
                socket.send(JSON.stringify({ type: 'join', payload: { username: username } }));
                ui.joinOverlay.style.display = 'none';
                ui.input.disabled = false;
                ui.sendButton.disabled = false;
                ui.input.focus();
            }
        });

        ui.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = ui.input.value.trim();
            if (!message || !username) return;
            const type = activeChat === 'public' ? 'chat_message' : 'private_message';
            const payload = activeChat === 'public' ? { message } : { recipient: activeChat, message };
            socket.send(JSON.stringify({ type, payload }));
            if (type === 'private_message') addMessage({ username, message, isPrivate: true }, activeChat);
            ui.input.value = '';
        });

        // Inicjalizacja
        createChatWindow('public', 'Czat Publiczny');
        switchChat('public');
        updateUsers([]);
        connectWebSocket();
    </script>
</body>
</html>
