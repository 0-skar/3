<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Forum Czat</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        #messages { list-style-type: none; margin: 0; padding: 0; width: 80%; max-width: 600px; height: 70vh; overflow-y: scroll; border: 1px solid #ddd; margin-bottom: 10px; padding: 10px; }
        .system-message { color: grey; font-style: italic; }
        .user-message b { color: #007bff; }
        #form { display: flex; width: 80%; max-width: 622px; }
        #input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; }
        button { padding: 10px; }
    </style>
</head>
<body>
    <h1>Czat Forum w Czasie Rzeczywistym</h1>
    <ul id="messages"></ul>
    <form id="form" action="">
        <input id="input" autocomplete="off" placeholder="Wpisz swoją wiadomość..." />
        <button>Wyślij</button>
    </form>

    <script>
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        let socket;

        // Zapytaj o nazwę użytkownika przy ładowaniu strony
        const username = prompt("Proszę, podaj swoją nazwę użytkownika:", "Gość");
        if (!username) {
            alert("Nazwa użytkownika jest wymagana, aby dołączyć do czatu.");
            document.body.innerHTML = "Odśwież stronę i podaj nazwę użytkownika, aby kontynuować.";
        }
        
        // =================================================================================
        // --- POCZĄTEK ZMIAN: TUTAJ PODAJESZ ADRES SWOJEGO BACKENDU ---
        // =================================================================================

        // WAŻNE: Wklej tutaj skopiowany adres swojego Space'a z Hugging Face!
        const hfSpaceUrl = "https://eosforus-chat.hf.space"; // <-- UZUPEŁNIJ TO POLE!

        // Automatyczne budowanie adresów URL dla WebSocket i historii czatu
        const wsUrl = `wss://${hfSpaceUrl}/ws/${username}`;
        const historyUrl = `https://${hfSpaceUrl}/history`;

        // =================================================================================
        // --- KONIEC ZMIAN ---
        // =================================================================================


        // Funkcja do dodawania wiadomości do okna czatu
        function addMessage(data) {
            const item = document.createElement('li');
            if (data.username === "System") {
                item.className = 'system-message';
                item.textContent = data.message;
            } else {
                item.className = 'user-message';
                item.innerHTML = `<b>${data.username}:</b> ${data.message}`;
            }
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight; // Automatyczne przewijanie
        }
        
        // Funkcja do pobierania i wyświetlania historii czatu
        async function loadHistory() {
            try {
                const response = await fetch(historyUrl);
                if (!response.ok) {
                    throw new Error(`Błąd HTTP: ${response.status}`);
                }
                const history = await response.json();
                history.forEach(addMessage);
            } catch (error) {
                console.error("Nie udało się załadować historii czatu:", error);
                addMessage({username: "System", message: "Nie udało się załadować historii czatu."});
            }
        }

        // Funkcja do nawiązywania połączenia WebSocket
        function connectWebSocket() {
            if (!username) return;

            socket = new WebSocket(wsUrl);

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addMessage(data);
            };

            socket.onopen = function(event) {
                console.log("Połączenie WebSocket nawiązane.");
                // Załaduj historię dopiero po otwarciu połączenia
                loadHistory();
            };

            socket.onclose = function(event) {
                console.log("Połączenie WebSocket zamknięte. Próba ponownego połączenia...");
                setTimeout(connectWebSocket, 3000); // Spróbuj połączyć się ponownie co 3 sekundy
            };

            socket.onerror = function(error) {
                console.error("Błąd WebSocket:", error);
            };
        }

        // Obsługa wysyłania formularza
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(input.value);
                input.value = '';
            }
        });

        // Inicjalizacja połączenia
        connectWebSocket();
    </script>
</body>
</html>
