<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kontakty</title>
    <link rel="manifest" href="manifest.json?v=16">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
        :root {
            --bg-color: #23272a; --header-color: #1e2124; --text-color: #fff;
            --accent-color: #7289da; --green: #43b581; --red: #dc3545; --grey: #99aab5;
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .app-container { display: flex; flex-direction: column; height: 100%; visibility: hidden; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--header-color); flex-shrink: 0; }
        header a, header button { color: var(--grey); text-decoration: none; background: none; border: none; font-size: 1.8rem; cursor: pointer; padding: 5px; }
        #call-area { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        #caller-info { height: 60px; }
        #caller-name { font-size: 2.2rem; font-weight: bold; }
        #call-status { font-size: 1rem; color: var(--grey); margin-top: 5px; }
        #main-call-button { width: 100px; height: 100px; border-radius: 50%; border: none; font-size: 3rem; margin-top: 40px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .idle { background-color: var(--accent-color); } .calling-out, .in-call { background-color: var(--red); } .calling-in { background-color: var(--green); }
        footer { padding: 15px; background-color: var(--header-color); flex-shrink: 0; text-align: center; }
        #toggle-contacts-btn { font-size: 2rem; color: var(--accent-color); background: none; border: none; cursor: pointer; }
        #contacts-panel { position: fixed; bottom: 0; left: 0; right: 0; background-color: #2c2f33; border-top: 1px solid #444; max-height: 70%; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 100; }
        #contacts-panel.visible { transform: translateY(0); }
        #contacts-header { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid #444; cursor: pointer; }
        #contacts-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .contact-item { display: flex; align-items: center; padding: 15px; } .contact-name { flex-grow: 1; } .contact-call-btn { font-size: 1.5rem; color: var(--green); background: none; border: none; cursor: pointer; }
        
        /* EKRAN INSTALACYJNY */
        #install-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
        #install-screen h2 { font-size: 2rem; } #install-screen p { color: var(--grey); max-width: 300px; }
        #install-action-button { width: 100%; max-width: 300px; padding: 15px; background-color: var(--green); color: white; border: none; border-radius: 5px; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; cursor: pointer; }
        #skip-install-button { color: var(--grey); background: none; border: none; cursor: pointer; }
        
        /* WIZUALNE INSTRUKCJE */
        .manual-instructions { display: none; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .instruction-step { display: flex; align-items: center; background-color: var(--header-color); padding: 10px; border-radius: 8px; margin-top: 10px; }
        .instruction-icon { font-size: 2rem; margin-right: 15px; }
        .instruction-icon-ios-share { width: 30px; height: 30px; margin-right: 15px; }
        .instruction-text { text-align: left; }
    </style>
</head>
<body>
    <div id="install-screen">
        <h2>Mini-Telefon</h2>
        <p>Zainstaluj aplikacjƒô na pulpicie, aby mieƒá szybki dostƒôp do ulubionych kontakt√≥w.</p>
        <button id="install-action-button">Zainstaluj na pulpicie</button>
        <button id="skip-install-button">Pomi≈Ñ na razie</button>
        
        <div id="android-instructions" class="manual-instructions">
            <p><strong>Instrukcja dla Androida:</strong></p>
            <div class="instruction-step">
                <span class="instruction-icon">‚ãÆ</span>
                <span class="instruction-text">Naci≈õnij <strong>trzy kropki</strong> w rogu przeglƒÖdarki.</span>
            </div>
            <div class="instruction-step">
                <span class="instruction-icon">üì•</span>
                <span class="instruction-text">Wybierz <strong>"Zainstaluj aplikacjƒô"</strong>.</span>
            </div>
        </div>
        
        <div id="ios-instructions" class="manual-instructions">
            <p><strong>Instrukcja dla iPhone'a:</strong></p>
            <div class="instruction-step">
                <svg class="instruction-icon-ios-share" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 2.5V11M13.5 6L9 1.5 4.5 6M4 8.5H3a1.5 1.5 0 00-1.5 1.5v5A1.5 1.5 0 003 16.5h12a1.5 1.5 0 001.5-1.5v-5A1.5 1.5 0 0015 8.5h-1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="instruction-text">Naci≈õnij ikonƒô <strong>Udostƒôpnij</strong> na dolnym pasku.</span>
            </div>
            <div class="instruction-step">
                <span class="instruction-icon">‚äï</span>
                <span class="instruction-text">Przewi≈Ñ w d√≥≈Ç i wybierz <strong>"Do ekranu poczƒÖtkowego"</strong>.</span>
            </div>
        </div>
    </div>

    <div class="app-container">
        <header>
            <a id="forum-link" href="https://0-skar.github.io/3/" title="Przejd≈∫ do forum">‚åÇ</a>
            <button id="help-install-button" title="Jak zainstalowaƒá?">?</button>
            <button id="close-button" title="Zamknij">‚ùå</button>
        </header>
        <main id="call-area">
            <div id="caller-info">
                <div id="caller-name">Gotowy</div>
                <div id="call-status">Wybierz kontakt, aby zadzwoniƒá</div>
            </div>
            <button id="main-call-button" class="idle">üìû</button>
        </main>
        <footer><button id="toggle-contacts-btn" title="Ulubione Kontakty">‚≠ê</button></footer>
        <div id="contacts-panel">
            <div id="contacts-header">Ulubione Kontakty</div>
            <ul id="contacts-list"></ul>
        </div>
    </div>

    <script>
        const hfSpaceUrl = "eosforus-chat.hf.space"; const wsUrl = `wss://${hfSpaceUrl}/ws/`;
        let socket, myUsername, peerConnection, currentCallPartner; let callState = 'IDLE';
        const ui = { appContainer: document.querySelector('.app-container'), installScreen: document.getElementById('install-screen'), installActionButton: document.getElementById('install-action-button'), skipInstallButton: document.getElementById('skip-install-button'), androidInstructions: document.getElementById('android-instructions'), iosInstructions: document.getElementById('ios-instructions'), helpInstallButton: document.getElementById('help-install-button'), forumLink: document.getElementById('forum-link'), closeButton: document.getElementById('close-button'), callerName: document.getElementById('caller-name'), callStatus: document.getElementById('call-status'), mainCallButton: document.getElementById('main-call-button'), toggleContactsBtn: document.getElementById('toggle-contacts-btn'), contactsPanel: document.getElementById('contacts-panel'), contactsHeader: document.getElementById('contacts-header'), contactsList: document.getElementById('contacts-list'), };
        
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('installSkipped') || window.matchMedia('(display-mode: standalone)').matches) {
                showApp();
            } else {
                setupInstallScreen();
            }
        });

        function showApp() { ui.installScreen.style.display = 'none'; ui.appContainer.style.visibility = 'visible'; initializeApp(); }
        
        function setupInstallScreen() {
            ui.installActionButton.addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choice) => {
                        if (choice.outcome === 'accepted') { localStorage.setItem('installSkipped', 'true'); showApp(); }
                    });
                } else {
                    const os = getOS();
                    if (os === 'iOS') { ui.iosInstructions.style.display = 'block'; } 
                    else { ui.androidInstructions.style.display = 'block'; }
                }
            });
            ui.skipInstallButton.addEventListener('click', () => { localStorage.setItem('installSkipped', 'true'); showApp(); });
        }
        
        function getOS() {
            const userAgent = window.navigator.userAgent;
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) { return 'iOS'; }
            return 'Android';
        }

        function initializeApp() { setupEventListeners(); const urlParams = new URLSearchParams(window.location.search); const caller = urlParams.get('caller'); if (caller) { setState('INCOMING_CALL', { name: caller }); } connectForContacts(); }
        function setupEventListeners() {
            ui.helpInstallButton.addEventListener('click', () => {
                localStorage.removeItem('installSkipped'); window.location.reload();
            });
            ui.closeButton.addEventListener('click', () => window.close());
            ui.toggleContactsBtn.addEventListener('click', () => ui.contactsPanel.classList.add('visible'));
            ui.contactsHeader.addEventListener('click', () => ui.contactsPanel.classList.remove('visible'));
            ui.mainCallButton.addEventListener('click', handleMainButtonClick);
        }

        // Reszta skrypt√≥w (setState, updateUI, handleMainButtonClick, etc.) jest taka sama.
        // Wklejone poni≈ºej dla kompletno≈õci.
        function setState(newState, data = {}) { callState = newState; currentCallPartner = data.name || null; const forumBaseUrl = "https://0-skar.github.io/3/"; if (currentCallPartner) { ui.forumLink.href = `${forumBaseUrl}?action=autologin&chat_with=${currentCallPartner}`; } else { ui.forumLink.href = `${forumBaseUrl}?action=autologin`; } updateUI(data); }
        function updateUI(data = {}) { const { name, status } = data; ui.mainCallButton.className = 'main-call-button'; switch (callState) { case 'INCOMING_CALL': ui.callerName.textContent = name; ui.callStatus.textContent = "Dzwoni do Ciebie..."; ui.mainCallButton.innerHTML = "üìû"; ui.mainCallButton.classList.add('calling-in'); break; case 'OUTGOING_CALL': ui.callerName.textContent = name; ui.callStatus.textContent = "Dzwonienie..."; ui.mainCallButton.innerHTML = "‚ùå"; ui.mainCallButton.classList.add('calling-out'); break; case 'IN_CALL': ui.callerName.textContent = name; ui.callStatus.textContent = "Trwa rozmowa"; ui.mainCallButton.innerHTML = "‚ùå"; ui.mainCallButton.classList.add('in-call'); break; default: ui.callerName.textContent = "Gotowy"; ui.callStatus.textContent = status || "Wybierz kontakt, aby zadzwoniƒá"; ui.mainCallButton.innerHTML = "üìû"; ui.mainCallButton.classList.add('idle'); break; } }
        function handleMainButtonClick() { switch (callState) { case 'INCOMING_CALL': if (socket?.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ type: 'call_answered', payload: { caller: currentCallPartner } })); initializeWebRTC(currentCallPartner); } else { connectForContacts(() => { socket.send(JSON.stringify({ type: 'call_answered', payload: { caller: currentCallPartner } })); initializeWebRTC(currentCallPartner); }); } break; case 'OUTGOING_CALL': case 'IN_CALL': if (peerConnection) peerConnection.close(); if (socket?.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ type: 'webrtc_signal', payload: { recipient: currentCallPartner, signal: { type: 'hangup' } } })); } setState('IDLE', { status: "Rozmowa zako≈Ñczona" }); break; } }
        function connectForContacts(callback) { if (socket && socket.readyState === WebSocket.OPEN) { if(callback) callback(); return; } socket = new WebSocket(wsUrl); socket.onopen = () => { myUsername = localStorage.getItem('forumUsername'); if (myUsername) { socket.send(JSON.stringify({ type: 'join', payload: { username: myUsername, password: localStorage.getItem('forumPassword') || '' } })); } else { updateUI({ status: "Zaloguj siƒô na forum" }); } }; socket.onmessage = (event) => { const data = JSON.parse(event.data); switch (data.type) { case 'join_success': if (callback) callback(); break; case 'user_update': renderContacts(data.payload.users); break; case 'webrtc_signal': handleWebRTCSignal(data.payload.sender, data.payload.signal); break; case 'call_answered': setState('IN_CALL', { name: data.payload.callee }); break; case 'call_declined': case 'recipient_busy': setState('IDLE', { status: `${data.payload.recipient || data.payload.callee} jest niedostƒôpny.` }); break; } }; socket.onclose = () => updateUI({ status: "Roz≈ÇƒÖczono" }); }
        function renderContacts(allUsers) { const me = allUsers.find(u => u.username === myUsername); ui.contactsList.innerHTML = ''; if (!me || !me.relationships) return; const favorites = Object.keys(me.relationships).filter(u => me.relationships[u] === 'favorite'); if (favorites.length === 0) { ui.contactsList.innerHTML = '<li class="contact-item" style="justify-content: center;">Brak ulubionych</li>'; return; } favorites.forEach(username => { const li = document.createElement('li'); li.className = 'contact-item'; li.innerHTML = `<span class="contact-name">${username}</span><button class="contact-call-btn" title="Zadzwo≈Ñ do ${username}">üìû</button>`; li.querySelector('.contact-call-btn').onclick = () => { ui.contactsPanel.classList.remove('visible'); setState('OUTGOING_CALL', { name: username }); if (socket?.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ type: 'initiate_call', payload: { recipient: username } })); initializeWebRTC(username); } }; ui.contactsList.appendChild(li); }); }
        async function initializeWebRTC(targetUser) { try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); peerConnection = createPeerConnection(targetUser); stream.getTracks().forEach(track => peerConnection.addTrack(track, stream)); if (callState === 'OUTGOING_CALL') { const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer); sendSignal(targetUser, { type: 'offer', sdp: offer.sdp }); } } catch (err) { setState('IDLE', { status: "B≈ÇƒÖd mikrofonu" }); } }
        function createPeerConnection(targetUser) { const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }); pc.onicecandidate = e => e.candidate && sendSignal(targetUser, { type: 'ice-candidate', candidate: e.candidate }); pc.ontrack = e => { const audio = document.createElement('audio'); audio.srcObject = e.streams[0]; audio.autoplay = true; document.body.appendChild(audio); setState('IN_CALL', { name: targetUser }); }; pc.onconnectionstatechange = () => { if (['disconnected', 'closed', 'failed'].includes(pc.connectionState)) { if (callState !== 'IDLE') setState('IDLE', { status: "Po≈ÇƒÖczenie zako≈Ñczone." }); peerConnection = null; } }; return pc; }
        function sendSignal(recipient, signal) { if (socket?.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ type: 'webrtc_signal', payload: { recipient, signal } })); } }
        async function handleWebRTCSignal(sender, signal) { if (!peerConnection) initializeWebRTC(sender); try { if (signal.type === 'offer') { await peerConnection.setRemoteDescription(new RTCSessionDescription(signal)); const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer); sendSignal(sender, { type: 'answer', sdp: answer.sdp }); } else if (signal.type === 'answer') { await peerConnection.setRemoteDescription(new RTCSessionDescription(signal)); } else if (signal.type === 'ice-candidate') { await peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate)); } else if (signal.type === 'hangup') { if (peerConnection) peerConnection.close(); } } catch (err) { console.error("B≈ÇƒÖd WebRTC Signal:", err); } }
    </script>
</body>
</html>
